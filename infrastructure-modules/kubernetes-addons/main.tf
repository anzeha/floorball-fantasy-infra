resource "google_compute_address" "ingress" {
  count = var.deploy_nginx ? 1 : 0
  name    = format("%s-ingress-ip", var.cluster_name)
  project = var.project_id
  region  = var.region
}

resource "kubernetes_namespace_v1" "floorball_fantasy_namespace" {
    count = var.create_app_namespace ? 1 : 0
    metadata {
      name = var.app_namespace
    }
}


module "nginx-controller" {
  count = var.deploy_nginx ? 1 : 0
  source = "terraform-iaac/nginx-controller/helm"

  ip_address = google_compute_address.ingress[0].address

}

resource "kubernetes_secret" "gke_cluster" {
  metadata {
    name      = "gke-cluster-staging"
    namespace = "argocd"
    labels = {
      "argocd.argoproj.io/secret-type" : "cluster"
    }
  }

  type = "Opaque"

  data = {
    config = jsonencode({
      bearerToken = "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZGVwbG95bWVudC00MzM5MTMiLAogICJwcml2YXRlX2tleV9pZCI6ICI4NzkyOGRjZDliNTM1MGIxNTU2NDc4YTE2NDc5NjFmN2Q1MzNhZmQ2IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdkFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLWXdnZ1NpQWdFQUFvSUJBUUMyNUlOZVc2UHljSHd5XG5VVDlDeHpMb01YN3BTWXgraUNuWkJDQWZ4Y2laOEtmU2xHcUlhdmZrMll5VEpWYkd2YUFvdHFlLzBuSjE5ckh2XG4vNmZsMkZXOHhkd2VneW5URGlOOERiZUpRZmkrbzFPMWRkZ0YyMkZTZEN0RFRiV3NudVlCOTdIdEZBMFdTbVlmXG5rK0l4TVIzaWtnUnlncEtBT1JWMkxNL3M1N3RkQTJiUUk5L0tWbjB4ZVRkTkpNYmJmYVRnajVaWkhTNzZiOTc4XG5wZkhiT1NiVkg0em9zcUpIbzgwVkZOeXBWQjFBeENERlViL2JYMmF1U09USjR4OXd1TkRPL2VoQXhpS1RONmsxXG4zejNPZHV5R1U4azhwYmtyR0RlTFRXWGZEdzRSZUxzK2tIL0hpbFdPeDUvSWFxUGVCdUgybGg5cEJJcG5uWG1rXG5FNzhBaHRrSEFnTUJBQUVDZ2dFQUx4dE1ldEUvdVFJZit4WFNKWEVKTzZVRCt6Sm1iWERFMXBDcGRZV0wxWnFXXG5uelo2K2dnVE1XNlhObzgzZXBqODEzKzBWVVB2RjFNaklaM0hzUHUzbVplY3luOGVGcTVkbFdZekQ3ZGVTanZuXG5JNlhtcmh1RFJhbUdPeCtZMjQxUjBNL3JsQlRHQ2llL2hnS2hEK3FHdUFURUFIcUJJV1dTa1kyWlFIdXZWcFZKXG5hL0pSNm5wZ05IdUt1NlcvNEFtbk1YNVljTGo1eWhvYnpFdDhzaWhQalRhaXQ3aGZndkE5Z1FiZ0RYdC9wZVVUXG5XeEFrMlZkb0kzem5sMVhOYjhoRVo2U25BOVJVeUFZTkM0Vk1QU2pKVk1YemdMYUNWTUtqbkcrN0pJYnNYZVN1XG5vTzZ6TjkzWnV4VHZOM2RLQWx2RVJCUjNZeVMrUmQ1WWdzZGc5eE9hZ1FLQmdRRDBWS2FEa01wUEJkMTBkUGZ1XG5OT21pZXdEZ2U1MDV0Qm5PUzJSSWllQXZwQW1HTFh3ZFo4Qmp2OUl3L2dSdHV2b2ozVDAyMnRtMzRwR0I1MlR4XG5MWkZ4cG5TcEJpM09GaWVaVDg5Q1FaL3JEekhTU3BrWUh0QjN5amx4cGJBZFVYd3Q5OE11VklyQ2hiSXZoUWlOXG5RVkEvUTJLWk5lRGhVbDBjZDIzQ3lBVmxBd0tCZ1FDL29LNHFoMzdxUHBtVzBLVkZSWjFjK3ZMR24xdml5VTlzXG5qNmpsU2YzeHhRTGJrRlp3a0E4VkhPWDEydkJkdWlGeUd6b2wydmUxTHFTSXJLbkpPOG1relNrdEpOT21VWGFnXG52VUxTZ1IzREkrbkpPYmtjSlRMQSswT2tVNHZSWCtFdlNNaWxFTFVPS3hOWFV3Nlh6T242VE9sWFFJdEFsTEl4XG5lc2plNGcweXJRS0JnRmNKZUsvUmVtQWdKTDJCbFhpRDNONkdsczlnK2FjK294cTcvS05paWp3dVlUNHRJZE9QXG56QmM4ay9IajYwdnptWHdCS2ZkS2l0aFltNkQ4L3haek55YVhOMk9tMGRaaVNnVHhTMUc4OHV6WFl0WVl3T1M0XG54V2FHNFdPOHREb2RkdkVoRzZSN2RWcktLYW1INkgzNVVFN1pBRnkzdHI1Tml1SERJWlNMa0hCbEFvR0FMTXhLXG5peVM3OWRVR29PeE1Cc0s4aEJVaWxtNkEwNmJPUzRuV0tTeEFFcnBFN2NGemc4TVowNHk2OGR2cUgyODVER3p6XG5EaEIvb2pxeU9rVnJOK0VqUmNTMG9Kb2daSnhjeUQwV2x4R2FQSmx6dVJnbWZ6N3UrNUNDQXJPSlZ6dzc3NHJyXG5aVE5mc0YwL20wV09mc3huMHAwU1c5UjUrWElKcW1tUzloQVFsODBDZ1lCQkd5UVVBTGVTaWc3VjVNSjhiUFNxXG4wWFhCQnRkRlYzZ05xNEhqWGNBb1ZSTXkzNzVhT25HaGFYeXN4WUdKdFo2bHBrYXM3YnZZRVpTVTZ5Y3JkNFhRXG5pM2ZFeXk2aUthUXV6SGdlODNaTkxscXlkTVZQOThwQlpCMUtyR0FLMXZZSFM0V3ZBaHBucUIrMldST0QwWHlBXG4vR0FuR3V0MERiZEdlTHZLeitYUGFRPT1cbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJhbnplaGFAZGVwbG95bWVudC00MzM5MTMuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTAxMTY0OTYwODYxNDUzNDYyODMyIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9hbnplaGElNDBkZXBsb3ltZW50LTQzMzkxMy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo",
      tlsClientConfig = {
        insecure = true,
      }
    })
    name   = "gke_floorball-fantasy_europe-west4-a_ffantasy-gke-cluster-staging"
    server = "https://34.91.61.149"
  }
}